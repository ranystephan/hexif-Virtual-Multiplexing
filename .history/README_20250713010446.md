# SPACEc CODEX Analysis Workflow

This repository contains a comprehensive workflow for analyzing CODEX (CO-Detection by indeXing) data from clear cell renal cell carcinoma (ccRCC) and clear cell ovarian carcinoma (ccOC) tissue microarrays using SPACEc (Spatial Protein Analysis with Clustering and Enrichment).

## Overview

The workflow processes multiplexed tissue imaging data to extract single-cell protein expression profiles and spatial coordinates, enabling comprehensive analysis of tissue architecture and cellular interactions.

## Key Features

- **Multi-channel Image Processing**: Handles CODEX TIF and QPTIFF formats
- **Deep Learning Segmentation**: Uses Mesmer/Cellpose for accurate cell segmentation
- **Comprehensive Preprocessing**: Filtering, normalization, and noise removal
- **Unsupervised Clustering**: Identifies cell populations based on protein expression
- **Spatial Analysis**: Extracts cell locations and spatial relationships
- **Rich Visualizations**: Creates publication-quality plots and heatmaps

## Installation

### Prerequisites

- Python 3.8+
- CUDA-compatible GPU (optional, for faster segmentation)

### Required Packages

```bash
pip install spacec scanpy pandas numpy matplotlib seaborn
pip install tifffile pillow scikit-learn
```

### Optional GPU Support

For faster segmentation with GPU acceleration:

```bash
pip install tensorflow-gpu  # or pytorch with CUDA support
```

## Data Structure

Your data should be organized as follows:

```
data/nomad_data/CODEX/
├── MarkerList.txt                    # List of protein markers
├── ccRCC_TMAs_Map_adg.xlsx          # TMA mapping file
├── ccOC_TMAs_map_adg.xlsx           # TMA mapping file
├── 140224_ccRCC_TMA1_adg/           # TMA directory
│   ├── bestFocus/                   # Best focus TIF files
│   │   ├── A-1.tif
│   │   ├── A-2.tif
│   │   └── ...
│   └── Scan1/                       # Raw CODEX data
│       ├── *.qptiff
│       └── MarkerList.txt
└── [other TMA directories...]
```

## Usage

### 1. Run the Main Analysis Notebook

```bash
jupyter notebook scripts/nomad_scripts/spacec_codex.ipynb
```

### 2. Expected Outputs

The analysis generates several key output files:

- **`protein_x_cell_expression_matrix.csv`**: Main expression matrix (cells × proteins)
- **`cell_spatial_coordinates.csv`**: Cell locations and metadata
- **`cell_metadata.csv`**: Complete cell metadata including clusters
- **`preprocessed_adata.h5ad`**: AnnData object for further analysis
- **`analysis_summary.txt`**: Detailed analysis summary
- Various visualization files (PNG/PDF format)

### 3. Loading Results

```python
import pandas as pd
import scanpy as sc

# Load expression matrix
expression_matrix = pd.read_csv('output/spacec_analysis/protein_x_cell_expression_matrix.csv', index_col=0)

# Load spatial coordinates
spatial_coords = pd.read_csv('output/spacec_analysis/cell_spatial_coordinates.csv')

# Load AnnData object
adata = sc.read_h5ad('output/spacec_analysis/preprocessed_adata.h5ad')
```

## Workflow Steps

### 1. Data Inspection and Visualization
- Explore TMA directory structure
- Create thumbnail grids of tissue images
- Validate data integrity

### 2. Cell Segmentation
- Use deep learning models (Mesmer/Cellpose) for cell segmentation
- Visualize segmentation quality
- Extract single-cell measurements

### 3. Preprocessing
- Filter cells by size and nuclear intensity
- Normalize protein expression data
- Remove noisy cells

### 4. Clustering and Cell Type Identification
- Perform unsupervised clustering using Leiden algorithm
- Visualize clusters in UMAP space
- Analyze marker expression patterns

### 5. Expression Matrix Extraction
- Generate protein × cell expression matrices
- Extract spatial coordinates for each cell
- Create comprehensive metadata

### 6. Spatial Analysis and Visualization
- Create spatial plots of cell clusters
- Generate expression heatmaps
- Visualize marker expression patterns

## Key Output Files

### Expression Matrix (`protein_x_cell_expression_matrix.csv`)
- Rows: Individual cells
- Columns: Protein markers
- Values: Normalized expression levels

### Spatial Coordinates (`cell_spatial_coordinates.csv`)
- `x`, `y`: Cell centroid coordinates
- `cell_id`: Unique cell identifier
- `unique_region`: Region/TIF file identifier
- `condition`: Sample condition (ccRCC/ccOC)
- `cluster`: Assigned cluster/cell type

### Cell Metadata (`cell_metadata.csv`)
- Complete cell information including:
  - Morphological features (area, perimeter, etc.)
  - Expression levels for all markers
  - Cluster assignments
  - Spatial coordinates

## Customization

### Adjusting Parameters

Key parameters can be modified in the notebook:

```python
# Segmentation parameters
seg_method = 'mesmer'  # or 'cellpose'
resize_factor = 1      # Reduce for large images
size_cutoff = 0        # Minimum cell size

# Clustering parameters
n_neighbors = 15       # KNN graph neighbors
resolution = 1.0       # Clustering resolution
clustering_random_seed = 42  # For reproducibility

# Filtering thresholds
one_percent_area = np.percentile(df_seg.area, 1)
one_percent_nuc = np.percentile(df_seg.DAPI, 1)
```

### Adding Custom Markers

Update the marker list in `MarkerList.txt` or modify the clustering markers:

```python
clustering_markers = [
    'CD3', 'CD4', 'CD8', 'CD20', 'CD68', 'CD45', 'panCK',
    # Add your custom markers here
]
```

## Troubleshooting

### Common Issues

1. **Memory Issues**: Reduce `resize_factor` or process fewer TIF files
2. **Segmentation Errors**: Check image format and channel order
3. **Missing Markers**: Verify marker names match exactly with data
4. **GPU Issues**: Set `resize_factor < 1` or use CPU-only mode

### Performance Tips

- Use GPU acceleration for segmentation when available
- Process TIF files in batches for large datasets
- Save intermediate results to avoid re-computation

## References

- **SPACEc Documentation**: https://spacec.readthedocs.io/
- **CODEX Technology**: https://www.akoyabio.com/codex/
- **Scanpy Documentation**: https://scanpy.readthedocs.io/
- **Mesmer Segmentation**: https://github.com/vanvalenlab/deepcell-tf

## Citation

If you use this workflow in your research, please cite:

```bibtex
@article{spacec2023,
  title={SPACEc: Spatial Protein Analysis with Clustering and Enrichment},
  author={[Author names]},
  journal={[Journal]},
  year={2023}
}
```

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Contact

For questions or issues, please contact [your email] or open an issue on GitHub. 