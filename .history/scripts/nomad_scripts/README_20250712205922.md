# CODEX Processing Pipeline

This directory contains scripts to process CODEX (CO-Detection by indEXing) data and extract protein expression matrices and cell locations from Tissue Microarray (TMA) data.

## Overview

The pipeline processes CODEX data from multiple TMA directories to extract:
1. **Protein expression matrices** (protein x cell)
2. **Cell locations** (x, y coordinates)
3. **Cell segmentation and annotation**

## Files

- `codex_processing_pipeline.py` - Full SPACEc-based processing pipeline
- `simple_codex_processor.py` - Simplified version using basic image processing
- `requirements.txt` - Python dependencies
- `README.md` - This file

## Data Structure

Your CODEX data should be organized as follows:
```
data/nomad_data/CODEX/
├── MarkerList.txt                    # List of protein markers
├── pnael_clear_cell.pdf             # Panel documentation
├── ccRCC_TMAs_Map_adg.xlsx          # TMA mapping information
├── ccOC_TMAs_map_adg.xlsx           # TMA mapping information
├── 140224_ccRCC_TMA1_adg/           # TMA directory
│   ├── bestFocus/                    # Best focus images
│   └── Scan1/                        # Scan data
│       ├── *.qptiff                  # Processed image files
│       └── .temp/                    # Temporary files
├── 250203_ccOC_TMA1_adg/            # Another TMA directory
└── ...                               # More TMA directories
```

## Installation

### 1. Install Python Dependencies

```bash
pip install -r requirements.txt
```

### 2. Install SPACEc (for full pipeline)

```bash
pip install git+https://github.com/yuqiyuqitan/SPACEc.git
```

### 3. Install Additional Dependencies (for simple pipeline)

```bash
pip install opencv-python scikit-image
```

## Usage

### Option 1: Full SPACEc Pipeline

The full pipeline uses SPACEc for advanced tissue and cell segmentation:

```bash
python codex_processing_pipeline.py
```

**Features:**
- Advanced tissue extraction and segmentation
- Sophisticated cell segmentation
- Integration with SPACEc's analysis tools
- AnnData object creation for downstream analysis

### Option 2: Simple Pipeline

The simple pipeline uses basic image processing libraries:

```bash
python simple_codex_processor.py
```

**Features:**
- Basic cell segmentation using scikit-image
- Protein expression extraction
- Cell location extraction
- CSV output format

## Output

Both pipelines generate the following outputs in `data/nomad_data/CODEX/processed/`:

### Per TMA Directory
```
processed/
├── 140224_ccRCC_TMA1_adg/
│   ├── 140224_ccRCC_TMA1_Scan1_expression_matrix.csv
│   ├── 140224_ccRCC_TMA1_Scan1_cell_locations.csv
│   ├── 140224_ccRCC_TMA1_Scan1_summary.json
│   └── ...
├── 250203_ccOC_TMA1_adg/
│   └── ...
└── combined_expression_matrix.csv
```

### File Descriptions

1. **`*_expression_matrix.csv`**
   - Rows: Individual cells
   - Columns: Protein markers (DAPI, CD3, CD31, etc.)
   - Values: Mean fluorescence intensity per cell per marker

2. **`*_cell_locations.csv`**
   - Rows: Individual cells (matching expression matrix)
   - Columns: x, y coordinates
   - Values: Spatial coordinates of cell centroids

3. **`*_summary.json`**
   - Processing metadata
   - Number of cells and markers
   - File paths and processing status

4. **`combined_expression_matrix.csv`**
   - Combined data from all TMAs
   - Additional columns: tma, tissue, cell_id

## Marker List

The pipeline automatically loads markers from `MarkerList.txt`. Your current markers include:

- **Nuclear markers**: DAPI
- **Immune markers**: CD3, CD4, CD8, CD45, CD56, CD57, CD68, CD163
- **Endothelial markers**: CD31, CD34, VEGFR1, VEGFR2, VEGFR3
- **Cancer markers**: CA9, PAX8, panCK, Vimentin
- **And many more...**

## Customization

### Adjusting Parameters

You can modify the following parameters in the scripts:

1. **Cell Segmentation Parameters** (in `simple_codex_processor.py`):
   ```python
   # In _segment_cells_simple method
   min_size=50          # Minimum cell area
   area_threshold=100   # Hole filling threshold
   sigma=1              # Gaussian blur sigma
   ```

2. **Tissue Extraction Parameters** (in `codex_processing_pipeline.py`):
   ```python
   # In _process_qptiff_file method
   downscale_factor=64  # Image downscaling factor
   lower_cutoff=0.2     # Tissue intensity lower bound
   upper_cutoff=0.21    # Tissue intensity upper bound
   ```

### Adding New Markers

To add new markers, simply update `MarkerList.txt`:
```
DAPI
CD3
CD31
...
NEW_MARKER
```

## Troubleshooting

### Common Issues

1. **"SPACEc not found"**
   ```bash
   pip install git+https://github.com/yuqiyuqitan/SPACEc.git
   ```

2. **"OpenCV not available"**
   ```bash
   pip install opencv-python
   ```

3. **"scikit-image not available"**
   ```bash
   pip install scikit-image
   ```

4. **Large file processing**
   - The scripts handle large files by downscaling
   - Adjust `downscale_factor` for memory constraints
   - Consider processing TMAs individually

### Performance Tips

1. **Memory Management**:
   - Use smaller `downscale_factor` for large images
   - Process one TMA at a time if memory is limited

2. **Processing Speed**:
   - The simple pipeline is faster but less accurate
   - The full SPACEc pipeline is more accurate but slower

3. **Storage**:
   - Output files can be large (several GB for combined matrix)
   - Ensure sufficient disk space

## Next Steps

After processing, you can:

1. **Load the data in Python**:
   ```python
   import pandas as pd
   
   # Load expression matrix
   expr_matrix = pd.read_csv('combined_expression_matrix.csv')
   
   # Load cell locations
   locations = pd.read_csv('*_cell_locations.csv')
   ```

2. **Use with scanpy for analysis**:
   ```python
   import scanpy as sc
   
   # Load AnnData object (from full pipeline)
   adata = sc.read_h5ad('*_adata.h5ad')
   ```

3. **Visualize spatial data**:
   ```python
   import matplotlib.pyplot as plt
   
   plt.scatter(locations['x'], locations['y'], c=expr_matrix['CD3'])
   plt.show()
   ```

## References

- [SPACEc Documentation](https://spacec.readthedocs.io/en/latest/)
- [SPACEc GitHub Repository](https://github.com/yuqiyuqitan/SPACEc)
- [CODEX Technology](https://www.akoyabio.com/codex/)

## Support

For issues with:
- **SPACEc**: Check the [SPACEc documentation](https://spacec.readthedocs.io/en/latest/)
- **CODEX data format**: Refer to Akoya Biosciences documentation
- **Script errors**: Check the log files in the output directory 