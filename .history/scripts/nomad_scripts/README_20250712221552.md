# CODEX TMA Processing Pipeline

This directory contains a robust, production-ready pipeline for extracting protein × cell expression matrices and cell locations from CODEX TMA datasets.

## Overview

- **Input:** CODEX TMA directories with qptiff files and a MarkerList.txt
- **Output:**
  - Per-scan expression matrices (CSV)
  - Per-scan cell locations (CSV)
  - Per-scan summary (JSON)
  - Combined expression matrix (CSV) with all cells, all markers, and metadata

## Directory Structure

```
data/nomad_data/CODEX/
├── MarkerList.txt
├── <TMA_DIR_1>/
│   └── Scan1/
│       └── <scan>.qptiff
├── <TMA_DIR_2>/
│   └── Scan1/
│       └── <scan>.qptiff
└── ...
```

## Installation

1. **Install Python dependencies:**
   ```bash
   pip install numpy scikit-image opencv-python
   ```
   (pandas and matplotlib are optional, only needed for downstream analysis or visualization)

2. **(Optional) For real CODEX data:**
   - Replace the dummy image loader in `codex_processor_v2.py` with your actual qptiff loader or SPACEc functions.

## Usage

Run the pipeline from this directory:

```bash
python codex_processor_v2.py
```

- The script will automatically:
  - Detect all TMA directories
  - Process all scans
  - Segment cells, extract features, and save results
  - Combine all results into a single CSV

## Output

All results are saved in `data/nomad_data/CODEX/processed/`:

- `<TMA_DIR>/<scan>_expression_matrix.csv` — protein × cell matrix for each scan
- `<TMA_DIR>/<scan>_cell_locations.csv` — cell centroid coordinates
- `<TMA_DIR>/<scan>_summary.json` — processing metadata
- `combined_expression_matrix.csv` — all cells, all markers, with TMA/tissue/cell_id metadata

## Marker List

Markers are loaded from `MarkerList.txt` in the data root. Edit this file to change the set of proteins analyzed.

## Customization

- **Cell segmentation parameters** can be adjusted in the `_segment_cells_simple` method.
- **Feature extraction** is mean intensity per marker per cell (can be customized in code).
- **Image loading**: Replace the dummy loader with your real CODEX/qptiff loader for production use.

## Troubleshooting

- If you see errors about missing packages, install them with `pip install ...` as above.
- If you process real data, ensure your qptiff loader is correct.
- For very large datasets, ensure you have enough disk space for the combined CSV.

## Support

- For CODEX data format: see Akoya Biosciences documentation
- For script errors: check the log output for details

---

**This pipeline is now robust, modular, and ready for production or further extension.** 