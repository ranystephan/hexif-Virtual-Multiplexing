# CODEX TMA Processing Pipeline with SPACEc

This repository contains a comprehensive pipeline for processing CODEX (CO-Detection by indEXing) TMA (Tissue Microarray) data using **SPACEc**, the specialized tool designed for spatial transcriptomics and CODEX data analysis.

## Why SPACEc?

SPACEc is specifically designed for spatial transcriptomics and CODEX data processing, providing:

- **Tissue Extraction**: Automated segmentation of individual tissue pieces from TMA images
- **Cell Segmentation**: Integration with state-of-the-art cell segmentation tools (Cellpose, Mesmer)
- **Feature Extraction**: Proper extraction of protein expression data from segmented cells
- **AnnData Integration**: Seamless integration with the AnnData format for downstream analysis
- **Spatial Analysis**: Built-in tools for spatial analysis and visualization

## Pipeline Overview

The SPACEc-based pipeline follows the proper workflow for CODEX data:

1. **Tissue Extraction**: Segment individual tissue pieces from TMA images
2. **Cell Segmentation**: Identify individual cells using Cellpose or Mesmer
3. **Feature Extraction**: Extract protein expression data for each cell
4. **Data Integration**: Combine data across tissues and TMAs
5. **Output Generation**: Create expression matrices and cell location data

## Installation

### Prerequisites

- Python 3.8 or higher
- Git

### Install Dependencies

```bash
# Clone the repository
git clone <repository-url>
cd hexif/scripts/nomad_scripts

# Install dependencies
pip install -r requirements.txt
```

**Note**: SPACEc installation may take some time as it includes deep learning dependencies for cell segmentation.

## Data Structure

Your CODEX data should be organized as follows:

```
data/nomad_data/CODEX/
├── MarkerList.txt                    # List of protein markers
├── ccOC_TMAs_map_adg.xlsx           # TMA mapping file
├── ccRCC_TMAs_Map_adg.xlsx          # TMA mapping file
├── pnael_clear_cell.pdf             # Panel information
├── TMA_001/                         # TMA directory
│   └── Scan1/
│       └── TMA_001_Scan1_er.qptiff  # CODEX image file
├── TMA_002/
│   └── Scan1/
│       └── TMA_002_Scan1_er.qptiff
└── ...
```

## Usage

### Run the SPACEc Pipeline

```bash
cd scripts/nomad_scripts
python spacec_codex_processor.py
```

### Configuration

The pipeline automatically:
- Detects TMA directories
- Loads marker information
- Processes each TMA using SPACEc
- Creates combined expression matrices

### Key Parameters

You can modify these parameters in the script:

- `downscale_factor`: For tissue segmentation (default: 64)
- `segmentation_model`: 'cellpose' or 'mesmer' (default: 'cellpose')
- `nuclear_channel`: Nuclear marker name (default: 'DAPI')
- `lower_cutoff`/`upper_cutoff`: Tissue intensity thresholds

## Output Structure

The pipeline generates:

```
data/nomad_data/CODEX/processed/
├── processing_summary.json          # Overall processing summary
├── combined_expression_matrix.h5ad  # Final combined AnnData
├── TMA_001/
│   ├── TMA_001_Scan1_er/
│   │   ├── reg001_expression_matrix.csv
│   │   ├── reg001_cell_locations.csv
│   │   ├── reg001_summary.json
│   │   └── TMA_001_Scan1_er_combined_adata.h5ad
│   └── TMA_001_combined_adata.h5ad
├── TMA_002/
│   └── ...
└── ...
```

### Output Files

- **Expression Matrices**: CSV files with protein expression data (cells × markers)
- **Cell Locations**: CSV files with x,y coordinates for each cell
- **AnnData Objects**: H5AD files for downstream analysis with scanpy
- **Summary Files**: JSON files with processing metadata

## SPACEc Workflow Details

### 1. Tissue Extraction
```python
# Downscale image for segmentation
resized_im = sp.hf.downscale_tissue(file_path, downscale_factor=64)

# Segment tissue pieces
tissueframe = sp.tl.label_tissue(resized_im, lower_cutoff=0.2, upper_cutoff=0.21)

# Extract individual tissues
sp.tl.save_labelled_tissue(filepath, tissueframe, output_dir, region=region)
```

### 2. Cell Segmentation
```python
# Perform cell segmentation
seg_output = sp.tl.cell_segmentation(
    file_path=tissue_file,
    channel_names_file=channel_file,
    segmentation_model='cellpose',
    nuclear_channel='DAPI'
)
```

### 3. Feature Extraction
```python
# Extract features and create AnnData
adata = sp.tl.extract_features(
    seg_output=seg_output,
    file_path=tissue_file,
    output_dir=output_dir
)
```

## Advantages of SPACEc Approach

1. **Specialized for CODEX**: Designed specifically for spatial proteomics data
2. **Robust Segmentation**: Uses proven cell segmentation algorithms
3. **Spatial Context**: Preserves spatial information throughout the pipeline
4. **Standardized Output**: Produces AnnData objects compatible with scanpy
5. **Comprehensive Analysis**: Includes tools for downstream spatial analysis

## Troubleshooting

### Common Issues

1. **SPACEc Installation**: If installation fails, try:
   ```bash
   pip install --upgrade pip
   pip install git+https://github.com/yuqiyuqitan/SPACEc.git
   ```

2. **Memory Issues**: For large images, reduce `downscale_factor`

3. **Segmentation Quality**: Adjust `lower_cutoff` and `upper_cutoff` for tissue detection

4. **Cell Segmentation**: Try different models ('cellpose' vs 'mesmer')

### Performance Tips

- Use SSD storage for faster I/O
- Ensure sufficient RAM (16GB+ recommended)
- Consider processing TMAs in parallel for large datasets

## Integration with Downstream Analysis

The generated AnnData objects can be used with:

- **Scanpy**: For clustering and differential expression
- **SPACEc**: For spatial analysis and visualization
- **Custom scripts**: For specialized analyses

## Citation

If you use this pipeline, please cite:

- SPACEc: [GitHub Repository](https://github.com/yuqiyuqitan/SPACEc)
- Cellpose: Stringer, C., Wang, T., Michaelos, M., & Pachitariu, M. (2021). Cellpose: a generalist algorithm for cellular segmentation. Nature Methods, 18(1), 100-106.
- Mesmer: Greenwald, N. F., Miller, G., Moen, E., Kong, A., Kagel, A., Dougherty, T., ... & Carpenter, A. E. (2021). Whole-cell segmentation of tissue images with human-level performance using large-scale data annotation and deep learning. Nature Biotechnology, 39(1), 74-82.

## Support

For issues related to:
- **SPACEc**: Check the [SPACEc documentation](https://github.com/yuqiyuqitan/SPACEc)
- **This pipeline**: Open an issue in this repository
- **CODEX data**: Refer to the CODEX documentation 